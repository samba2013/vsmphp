var Cloud = function () {
    var oTable = null;

    var getDraw=function(){

        return Cloud.drawIndex++;
    };


    var performAction=function(id,action,successFunc) {
        $.ajax({
            url:"controller/CloudApi.php",
            type:"post",
            dataType:"json",
            data:{
                actionSoloServer:action,
                SUBID:id,
                account_id: getRegionAccount().account_id,
                region_id: getRegionAccount().region_id,
            },
            success:successFunc,
            error:function (x,c,r) {
                console.log(x);
                $("#Loader").show();
                $("#clouds_wrapper").show();
            },
            beforeSend:function (xhr) {
                $("#Loader").show();
                $("#clouds_wrapper").hide();
            }
        })
    };

    var performDeploy=function(data,successFunc) {
        $.ajax({
            url:"controller/NewInstanceApi.php",
            type:"post",
            dataType:"json",
            data:data,
            success:successFunc,
            error:function (x,c,r) {
                console.log(x,c,r);
                $("#Loader").hide();
                $("#clouds_wrapper").show();
            },
            beforeSend:function (xhr) {
                $("#Loader").show();
                $("#clouds_wrapper").hide();

                $("#serverCreate").modal("hide");
                $("#deployInstances")[0].reset();
            }
        })
    };

    var performActionMulti=function(query,successFunc) {
        $.ajax({
            url:"controller/CloudApi.php",
            type:"post",
            dataType:"json",
            data:query+"&account_id="+getRegionAccount().account_id+"&region_id="+getRegionAccount().region_id,
            success:successFunc,
            error:function (x,c,r) {
                console.log(x);
                $("#Loader").show();
                $("#clouds_wrapper").show();
            },
            beforeSend:function (xhr) {
                $("#Loader").show();
                $("#clouds_wrapper").hide();
            }
        })
    };


    var getPlans=function(accountId,RegionId,successFunc) {

        $.ajax({
            url:"controller/NewInstanceApi.php",
            type:"post",
            data:{
                action:'get_plans',
                account_id: accountId,
                region_id: RegionId,
            },
            success:successFunc,
            error:function (x,c,r) {
                $("#PlansLoader").hide();
            },
            beforeSend:function (xhr) {
                $("#PlansLoader").show();
            }
        })
    };

    var buildDatatable=function() {

        Cloud.oTable = $('#clouds').DataTable( {
            "lengthMenu": [[5, 10, 25,50, -1], [5, 10, 25,50, "All"]],
            "processing": true,
            //"serverSide": true,
            "ajax": {
                url:"controller/CloudApi.php",
                type:'POST',
                data: function (d) {
                    return $.extend({}, d, {
                        "account_id": getRegionAccount().account_id,
                        "region_id": getRegionAccount().region_id,
                        "draw":getDraw()
                    });
                }
            },
            "columns": [
                { "data": "check" },
                { "data": "id" },
                { "data": "label" },
                { "data": "region" },
                { "data": "ipv4" },
                { "data": "ipv6" },
                { "data": "rdns" },
                { "data": "domain" },
                { "data": "power_status" },
                { "data": "server_state" },
                { "data": "actions" }
            ],
            columnDefs: [
                {"className": "text-center  align-middle", "targets": "_all"},
                {
                    orderable: false,
                    className: 'text-center  align-middle select-checkbox',
                    targets:   0,
                    searchable: false,
                    render: function (data, type, row, meta){
                        return '<input type="checkbox" name="subids[]" value="' + row.id + '">';
                    }
                },
                {
                    "targets":   [6,7,8,9,10],
                    "orderable": false,
                    "searchable": false
                },
                {
                    "targets":   8,
                    "orderable": false,
                    className: 'text-center align-middle',
                    "searchable": false,
                    render: function (data, type, full, meta){
                        var cls=(data!=='running')?'danger':'success';
                        return '<span class="badge badge-'+cls+'">'+data.toUpperCase()+'</span>';
                    }
                }

            ],

            select: {
                style:    'os',
                selector: 'td:first-child'
            },
            order: [[ 1, 'desc' ]]

        });

    };

    var performGetServers=function(){
        $("#refreshTable").click(function () {
            Cloud.oTable.ajax.reload();
        });
    };


    var performSelectAll= function(){
        $('#clouds').on("click","#cloud-select-all", function(){
            // Get all rows with search applied
            var rows = Cloud.oTable.rows({ 'search': 'applied' }).nodes();
            // Check/uncheck checkboxes for all rows in the table
            $('input[type="checkbox"]', rows).prop('checked', this.checked);
            $('input[type="checkbox"]', rows).trigger("change");

        });
    };


    var performOnChangeCheckbox = function () {
        $('#clouds tbody').on('change', 'input[type="checkbox"]', function(){
            // If checkbox is not checked
            if(!this.checked){
                var el = $('#cloud-select-all').get(0);
                // If "Select all" control is checked and has 'indeterminate' property
                if(el && el.checked && ('indeterminate' in el)){
                    // Set visual state of "Select all" control
                    // as 'indeterminate'
                    el.indeterminate = true;
                }
            }

            var subids = $("#subids").val().length>0 ? $("#subids").val().split(","):[];
            var currentValue = $(this).val();
            if($(this).is(":checked")){

                if(subids.includes(currentValue) == false){
                    subids.push(currentValue);
                }
            }else{

                if(subids.includes(currentValue) == true){
                    var index = subids.indexOf(currentValue);
                    subids.splice(index,1);
                }
            }
            $("#subids").val(subids.join(","));
        });

    };


    var performOnCloudStop = function () {
        $("#clouds").on("click","._Stop",function () {
            var Id = $(this).data("id");
            if(window.confirm("Confirm Stop Action")){
                performAction(Id,'stop',function (d) {
                    $("#text-info").text("Server "+Id+" successfully stopped");$("#alert-info").show();
                    $("#Loader").hide();
                    $("#clouds_wrapper").show();
                    setTimeout(function () {
                        $("#alert-info").hide();
                        Cloud.oTable.ajax.reload();

                    },1000);
                });
            }
        });
    };

    var performOnCloudStart=function(){
        $("#clouds").on("click","._Start",function () {
            var Id = $(this).data("id");
            if(window.confirm("Confirm Start Action")){
                performAction(Id,'start',function (d) {
                    $("#text-info").text("Server "+Id+" successfully started");$("#alert-info").show();
                    $("#Loader").hide();

                    $("#clouds_wrapper").show();
                    setTimeout(function () {
                        $("#alert-info").hide();
                        Cloud.oTable.ajax.reload();

                    },1000);
                });
            }
        });
    };

    var performOnCloudReboot = function(){
        $("#clouds").on("click","._Reboot",function () {
            var Id = $(this).data("id");
            if(window.confirm("Confirm Reboot Action")){
                performAction(Id,'reboot',function (d) {

                    $("#text-info").text("Server "+Id+" successfully rebooted");$("#alert-info").show();
                    $("#Loader").hide();
                    $("#clouds_wrapper").show();
                    setTimeout(function () {
                        $("#alert-info").hide();
                        Cloud.oTable.ajax.reload();

                    },1000);
                });
            }
        });
    };

    var performOnCloudDestroy=function(){
        $("#clouds").on("click","._Destroy",function () {
            var Id = $(this).data("id");
            if(window.confirm("Confirm Destroy Action")){
                performAction(Id,'destroy',function (d) {
                    $("#text-info").text("Server "+Id+" successfully destroyed");$("#alert-info").show();

                    $("#Loader").hide();
                    $("#clouds_wrapper").show();
                    setTimeout(function () {
                        $("#alert-info").hide();
                        Cloud.oTable.ajax.reload();

                    },1000);
                });
            }
        });
    };


    var getRegionAccount=function(){
        return {
            'account_id':$("#account_id").val(),
            'region_id':$("#region").val()
        };
    };

   var performOnAccountRegionChanged=function(){
       $("#account_id,#region").on("change",function () {
           var accountId = getRegionAccount().account_id;
           var regionId = getRegionAccount().region_id;
           if(
               !isNaN(parseInt(accountId)) && parseInt(accountId)>0
               && !isNaN(parseInt(regionId)) && parseInt(regionId)>0
           ){
               var typeId = $("#account_id option:selected").data("typeid");
               var accountType = types[typeId];
               getPlans(accountId,regionId,function (d) {
                   var obj = $.parseJSON(d);
                   var machine = $("#machine_id");
                   $("#PlansLoader").hide();

                   if(obj.error == null && obj.success==true){
                       var plans=obj.data.plans;
                       var available=obj.data.available;
                       machine.find("option").remove();
                       $.each(plans,function (planid,plan) {
                           if($.inArray(parseInt(planid),available)>=0){
                               $("<option value='"+planid+"'>"+plan.name+"</option>").appendTo(machine);
                           }

                       });
                       $("#CreateServer").removeAttr("disabled");
                       $("#maxinstances").val(accountType.maxinstances);
                       $("#total_server").prop("max",accountType.maxinstances);

                   }


               });


           }else{
               $("#CreateServer").prop("disabled",true);
           }
       });
   };

    var performMultiCloudAction=function () {
        $("#actionMulti").on("click",".dropdown-item",function () {


            var subids = $("#subids").val();
            if(subids.length == 0)
            {
                alert("No Servers Selected !");
                return false;
            }





            var action = $(this).data("action");
            query="subids="+subids+"&actionMultiServer="+action;

            if(window.confirm("Are you sure ?")){
                performActionMulti(query,function (d) {
                    $("#text-info").text("Multi action successfully completed");$("#alert-info").show();
                    $("#Loader").hide();

                    var rows = Cloud.oTable.rows({ 'search': 'applied' }).nodes();
                    $('input[type="checkbox"]', rows).prop('checked', false);
                    $('input[type="checkbox"]', rows).trigger("change");

                    $("#clouds_wrapper").show();
                    setTimeout(function () {
                        $("#alert-info").hide();
                        Cloud.oTable.ajax.reload();

                    },1000);
                });
            }
        });
    };

    var performDeployServer=function () {


        $("#serverCreate").on("click","#deployServer",function () {
            var form=document.getElementById("deployInstances");
            form.classList.add('was-validated');
            if (form.checkValidity() === false) {
                 event.preventDefault();
                 event.stopPropagation();
                 return false;
            }
            var osId=parseInt($("#os_id").val());
            var regionId=parseInt(getRegionAccount().region_id);
            var accountId=parseInt(getRegionAccount().account_id);
            var machineId=parseInt($("#machine_id").val());
            var total=parseInt($("#total_server").val());
            var default_password=$("#default_password").val();
            var maxinstances=parseInt($("#maxinstances").val());
            var domain=$("#server_domain").val();
            var name=$("#server_name").val();
            var startWith=$("#start_with").val();
            var ipv6Enabled=$("#ipv6enabled").is(":checked")?1:0;


            var data={
                "account_id":accountId,
                "region_id":regionId,
                "os_id":osId,
                "machine_id":machineId,
                "total":total,
                "default_password":default_password,
                "maxinstances":maxinstances,
                "domain":domain,
                "name":name,
                "start_with":startWith,
                "action":"deploy",
                "ipv6enabled":ipv6Enabled
            };

            performDeploy(data,function (result) {
                if(result.success == false){
                    alert(result.error);
                    $("#Loader").hide();
                    $("#clouds_wrapper").show();
                }else
                {
                    $("#text-info").text("Servers successfully created");$("#alert-info").show();
                    $("#Loader").hide();
                    $("#clouds_wrapper").show();
                    setTimeout(function () {
                        $("#alert-info").hide();
                        Cloud.oTable.ajax.reload();

                    },1000);
                }

            })




        })
    };

    return{
        init : function () {
            buildDatatable();
            performGetServers();
            performSelectAll();
            performOnChangeCheckbox();
            performOnCloudStop();
            performOnCloudStart();
            performOnCloudDestroy();
            performOnCloudReboot();
            performOnAccountRegionChanged();
            performMultiCloudAction();
            performDeployServer();
        },
        drawIndex:1,
        passwordGenerator:function (pLength){

            var keyListAlpha="abcdefghijklmnopqrstuvwxyz",
                keyListInt="123456789",
                keyListSpec="!@#_",
                password='';
            var len = Math.ceil(pLength/2);
            len = len - 1;
            var lenSpec = pLength-2*len;

            for (i=0;i<len;i++) {
                password+=keyListAlpha.charAt(Math.floor(Math.random()*keyListAlpha.length));
                password+=keyListInt.charAt(Math.floor(Math.random()*keyListInt.length));
            }

            for (i=0;i<lenSpec;i++)
                password+=keyListSpec.charAt(Math.floor(Math.random()*keyListSpec.length));

            password=password.split('').sort(function(){return 0.5-Math.random()}).join('');

            return password;
        }
    }
}();

// initialize and activate the script
$(function(){ Cloud.init(); });


